<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>PrinceIO - Host</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
            user-select: none;
        }

        /* Sidebar */
        .sidebar {
            width: 80px;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            z-index: 20;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-bottom: 40px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .nav-item {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            font-size: 20px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        /* Main Content */
        .content {
            flex: 1;
            position: relative;
            padding: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Animated Background */
        .bg-glow {
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
            pointer-events: none;
        }

        /* Cards */
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            z-index: 10;
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 8px;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 32px;
        }

        /* Inputs */
        .input-group {
            text-align: left;
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #cbd5e1;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-wrapper {
            position: relative;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        input,
        select {
            width: 100%;
            background: transparent;
            border: none;
            padding: 14px 16px;
            color: white;
            font-family: inherit;
            font-size: 15px;
            outline: none;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: wait;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
            margin-top: 24px;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .text-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 14px;
            margin-top: 24px;
            cursor: pointer;
        }

        .text-btn:hover {
            color: var(--primary);
        }

        /* Session View */
        .session-code-box {
            background: rgba(15, 23, 42, 0.8);
            border: 2px dashed rgba(99, 102, 241, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .session-code-box:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .code-text {
            font-family: 'Courier New', monospace;
            font-size: 32px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .icon-lg {
            font-size: 48px;
            margin-bottom: 24px;
            color: var(--primary);
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">P</div>
        <div class="nav-item active" title="Dashboard"><i class="fa-solid fa-desktop"></i></div>
        <div class="nav-item" title="Settings"><i class="fa-solid fa-gear"></i></div>
        <div class="nav-item" title="Help"><i class="fa-solid fa-circle-question"></i></div>
        <div class="nav-item" style="margin-top: auto;" id="logoutBtn" title="Logout">
            <i class="fa-solid fa-right-from-bracket"></i>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <div class="bg-glow"></div>

        <!-- AUTH VIEW -->
        <div id="authView" class="card">
            <h1 id="authTitle">Welcome Back</h1>
            <p>Sign in to access your dashboard</p>

            <div class="input-group">
                <label>Email</label>
                <div class="input-wrapper">
                    <input type="email" id="email" placeholder="name@company.com">
                </div>
            </div>

            <div class="input-group">
                <label>Password</label>
                <div class="input-wrapper">
                    <input type="password" id="password" placeholder="••••••••">
                </div>
            </div>

            <button class="btn btn-primary" id="authBtn">
                <span>Access Dashboard</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>

            <button class="text-btn" id="toggleAuth">Create a free account</button>

            <!-- DEV ONLY -->
            <button id="devSkipBtn"
                style="margin-top:20px; font-size:12px; opacity:0.5; border:1px dashed #64748b; padding:5px; width:100%; color:#64748b; background:transparent; cursor:pointer;">
                [DEV] Skip Login (Test Screen Share)
            </button>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="card hidden">
            <div class="icon-lg"><i class="fa-solid fa-share-nodes"></i></div>
            <h1>Start Session</h1>
            <p>Others can connect to this computer</p>

            <div class="input-group" style="text-align: left;">
                <label>Permission Level</label>
                <div class="input-wrapper">
                    <select id="permission">
                        <option value="control">Full Control (Recommended)</option>
                        <option value="view">View Only</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" id="createBtn">
                <i class="fa-solid fa-play"></i>
                <span>Generate Code</span>
            </button>

            <!-- Dev Log Container for Dashboard -->
            <div id="dashboardLogs" style="margin-top:20px; font-size:10px; color:#ef4444; text-align:center;"></div>
        </div>

        <!-- ACTIVE SESSION VIEW -->
        <div id="sessionView" class="card hidden">
            <div class="status-indicator" style="margin-bottom: 16px;">
                <span class="status-dot"></span> <span id="connStatus" style="font-size: 14px; color: #94a3b8;">Session
                    Active</span>
            </div>

            <div class="session-code-box" onclick="copyCode()">
                <div style="font-size: 10px; text-transform: uppercase; color: #64748b; margin-bottom: 4px;">Session
                    Code</div>
                <div class="code-text" id="sessionCode">---</div>
                <div style="font-size: 11px; color: var(--primary); margin-top: 4px;">Click to copy</div>
            </div>

            <!-- Video Preview -->
            <div
                style="margin-bottom: 20px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; height: 150px; background: black; position: relative;">
                <video id="localPreview" autoplay muted style="width: 100%; height: 100%; object-fit: contain;"></video>
                <div
                    style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; color: white; font-size: 10px;">
                    Preview</div>
            </div>

            <p style="margin-bottom: 24px; font-size: 13px;">Sharing your screen...</p>

            <!-- Debug Logs -->
            <div id="debugParams"
                style="margin-top:20px; font-size:10px; color:#64748b; text-align:left; max-height:100px; overflow-y:auto; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
                <div>Debug Logs:</div>
            </div>

            <button class="btn btn-danger" id="terminateBtn">
                <i class="fa-solid fa-stop"></i>
                <span>Stop Session</span>
            </button>
        </div>

    </div>

    <script>
        // Debug Logger
        function log(msg) {
            console.log(msg);
            const el = document.getElementById('debugParams');
            const dashLog = document.getElementById('dashboardLogs');

            if (el) {
                const line = document.createElement('div');
                line.innerText = `> ${msg}`;
                el.appendChild(line);
                el.scrollTop = el.scrollHeight;
            }
            if (dashLog) {
                dashLog.innerText = msg;
            }
        }

        const { ipcRenderer, clipboard } = require('electron');
        const { createClient } = require('@supabase/supabase-js');

        // SUPABASE CONFIG
        const SUPABASE_URL = 'https://flvdhpysrfqojqyxnhbn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsdmRocHlzcmZxb2pxeXhuaGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjA1ODMsImV4cCI6MjA4NTIzNjU4M30.3egSXvAJWf2NJ4hMJSOJEpznY4DJ900s082qUcrdcjQ';

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
        });

        // VIEW UTILS
        const views = {
            auth: document.getElementById('authView'),
            dashboard: document.getElementById('dashboardView'),
            session: document.getElementById('sessionView')
        };
        const switchView = (name) => {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[name].classList.remove('hidden');
        };

        // SKIP LOGIN
        document.getElementById('devSkipBtn').onclick = () => {
            switchView('dashboard');
            log('Skipped Login (Dev Mode)');
        };

        // AUTH LOGIC
        async function init() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) log('Auth Init Error: ' + error.message);

                if (session) switchView('dashboard');
                else switchView('auth');

                supabase.auth.onAuthStateChange((event, session) => {
                    log(`Auth Change: ${event}`);
                    if (session) switchView('dashboard');
                    else switchView('auth');
                });
            } catch (e) {
                log('Critical Auth Error: ' + e.message);
            }
        }
        init();

        let isLogin = true;
        const toggleAuth = document.getElementById('toggleAuth');
        const authTitle = document.getElementById('authTitle');
        const authBtn = document.getElementById('authBtn');
        const emailEl = document.getElementById('email');
        const passEl = document.getElementById('password');

        toggleAuth.onclick = () => {
            isLogin = !isLogin;
            authTitle.innerText = isLogin ? 'Welcome Back' : 'Create Account';
            authBtn.innerHTML = isLogin ? '<span>Access Dashboard</span><i class="fa-solid fa-arrow-right"></i>' : '<span>Sign Up Free</span><i class="fa-solid fa-user-plus"></i>';
            toggleAuth.innerText = isLogin ? 'Create a free account' : 'Already have an account? Login';
        };

        authBtn.onclick = async () => {
            const email = emailEl.value;
            const password = passEl.value;
            if (!email || !password) return alert('Please enter email and password');

            authBtn.disabled = true;
            try {
                if (isLogin) {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } else {
                    const { error } = await supabase.auth.signUp({ email, password });
                    if (error) throw error;
                    alert('Account created! Logging you in...');
                    // Auto login usually happens
                }
            } catch (e) {
                console.error(e);
                alert('Login Failed: ' + e.message);
                log('Login Error: ' + e.message);
            } finally {
                authBtn.disabled = false;
            }
        };

        // SESSION MANAGEMENT
        const createBtn = document.getElementById('createBtn');
        const terminateBtn = document.getElementById('terminateBtn');
        const sessionCodeEl = document.getElementById('sessionCode');
        const connStatus = document.getElementById('connStatus');
        const permissionEl = document.getElementById('permission');
        const logoutBtn = document.getElementById('logoutBtn');

        createBtn.onclick = async () => {
            createBtn.disabled = true;
            log('Creating Session...');
            try {
                const permission = permissionEl.value;
                const result = await ipcRenderer.invoke('create-session', { permission });
                log(`Session Created: ${result.sessionCode}`);
                sessionCodeEl.innerText = result.sessionCode;
                switchView('session');
            } catch (e) {
                log('Error creating session: ' + e.message);
                alert('Failed to create session: ' + e.message);
            } finally {
                createBtn.disabled = false;
            }
        };

        terminateBtn.onclick = async () => {
            await cleanup();
            switchView('dashboard');
        };

        logoutBtn.onclick = async () => {
            await supabase.auth.signOut();
            switchView('auth');
        };

        function copyCode() {
            const code = sessionCodeEl.innerText;
            if (code && code !== '---') {
                clipboard.writeText(code);
                alert('Code copied to clipboard!');
            }
        }

        // WEBRTC
        let pc = null;
        let localStream = null;
        const iceServers = [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            { urls: "stun:stun2.l.google.com:19302" },
            { urls: "stun:stun3.l.google.com:19302" },
            { urls: "stun:stun4.l.google.com:19302" },
            { urls: "stun:stun.services.mozilla.com" },
            {
                urls: "turn:openrelay.metered.ca:80",
                username: "openrelayproject",
                credential: "openrelayproject"
            },
            {
                urls: "turn:openrelay.metered.ca:443",
                username: "openrelayproject",
                credential: "openrelayproject"
            },
            {
                urls: "turn:openrelay.metered.ca:443?transport=tcp",
                username: "openrelayproject",
                credential: "openrelayproject"
            }
        ];

        ipcRenderer.on('viewer-joined', () => {
            connStatus.innerText = 'Connected - Sharing Screen';
            connStatus.style.color = '#4ade80';
            log('Viewer Joined! Starting Share...');
            startScreenShare();
        });

        // HANDLE ANSWER FROM VIEWER
        ipcRenderer.on('webrtc:answer', async (event, { sdp }) => {
            log('Received Answer from Viewer');
            if (pc) {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                    log('Remote Description Set (Connected)');
                } catch (e) {
                    log('Error setting remote desc: ' + e.message);
                }
            }
        });

        // HANDLE ICE CANDIDATES FROM VIEWER
        ipcRenderer.on('webrtc:ice', async (event, candidate) => {
            // log('Received ICE Candidate'); // Too spammy
            if (pc && candidate) {
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            }
        });

        async function startScreenShare() {
            try {
                log('Getting Screen Sources...');
                const sources = await ipcRenderer.invoke('get-sources');
                // Select the entire screen (usually the first one)
                const source = sources.find(s => s.name === 'Entire Screen' || s.name === 'Screen 1') || sources[0];
                log(`Source selected: ${source?.name} (${source?.id})`);

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        mandatory: {
                            chromeMediaSource: 'desktop',
                            chromeMediaSourceId: source.id,
                            minWidth: 1280,
                            maxWidth: 1920,
                            minHeight: 720,
                            maxHeight: 1080
                        }
                    }
                });
                log('Got User Media Stream');

                // Set Local Preview
                const preview = document.getElementById('localPreview');
                preview.srcObject = stream;

                localStream = stream;
                pc = new RTCPeerConnection({ iceServers });

                pc.onconnectionstatechange = () => {
                    log(`Connection State: ${pc.connectionState}`);
                };

                stream.getTracks().forEach(t => pc.addTrack(t, stream));

                pc.onicecandidate = e => {
                    if (e.candidate) ipcRenderer.send('webrtc:ice', JSON.parse(JSON.stringify(e.candidate)));
                };

                log('Creating Offer...');
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ipcRenderer.send('webrtc:offer', { sdp: JSON.parse(JSON.stringify(offer)) });
                log('Offer Sent to Signaling Server');

            } catch (e) {
                console.error(e);
                log('Error: ' + e.message);
                alert('Screen Share Error: ' + e.message);
            }
        }

        async function cleanup() {
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            if (pc) { pc.close(); pc = null; }
            connStatus.innerText = 'Waiting for connection...';
            connStatus.style.color = '#94a3b8';
            await ipcRenderer.invoke('terminate-session');
        }
    </script>
</body>

</html>